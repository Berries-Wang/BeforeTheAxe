# 从Maven 命令格式来理解Maven的生命周期和插件
## 1. 什么是Maven的生命周期
1. Maven的实际构建动作都是由插件来完成的。

&nbsp;&nbsp;Maven的生命周期就是为了对所有的构建过程进行抽象和统一。Maven从大量项目和构建工具中学习和反思，然后总结了一套高度完善的，易扩展的生命周期。这个生命周期包括了项目的清理、初始化、编译、测试、打包、集成测试、验证、部署和站点生成等几乎所有的构建步骤。换句话说 几乎所有的项目的构建，都能**映射**到这样一个生命周期上。
   - 即 类似于摸板方法

&nbsp;&nbsp;Maven的生命周期是抽象的，这意味着生命周期本身不做任何实际的工作，在Maven的设计中，实际的任务(如编译源代码)都交由插件来完成。这种思想和设计模式中的模板方法类似。模板方法模式在父类中定义了算法的整体结构，自雷可以通过实现或者重写父类的方法来控制实际的行为，这样既保证了算法有足够的可拓展性，又能够严格控制算法的整体结构   
```java
    public abstract class AbstraceBuild{

        public void build(){
            initialize();
            compile();
            test();
            packagee();
            integrationTest();
            deploy();
        }

        protect abstract void initialize();
        protect abstract void compile();
        protect abstract void test();
        protect abstract void packagee();
        protect abstract void integrationTest();
        protect abstract void deploy();

    }
```
- 这段代码很简单，build()方法定义了整个构建的过程，依次初始化、编译、测试、打包、集成测试和部署，但是这个类中没有具体的实现逻辑，他们都交由子类去实现。
- 虽然上述代码和Maven的实际代码相去甚远，Maven的生命周期包含更多的步骤和更复杂的逻辑，但是没有提供具体实现，那么谁来实现这些步骤呢? 因此，**Maven设计了插件机制。每个构建步骤都可以绑定一个或多个插件行为**，而且Maven为大多数构建步骤编写并绑定了默认的插件。例如，针对于编译插件有 maven-compiler-plugin,针对于测试插件 maven-surefire-plugin等。虽然在大多数时间中，用户几乎都不会察觉到插件的存在，但实际上编译是由maven-compiler-plugin完成的，而测试是由 maven-surefire-plugin完成的。当用户有特殊需要的时候，也可以配置插件定制构建行为，甚至自己编写插件。
   - 生命周期和插件的关系: <img src="./pics/maven-plugin-life-001.png"/>
   - Maven定义的生命周期和插件机制一方面保证了所有Maven项目对有一致的构建标准，另一方面又通过默认插件简化和稳定了实际项目的构建。此外，该机制还提供了足够的扩展空间，用户可以通过配置现有插件或者自行编写插件来自定义构建行为

## 2. [Maven生命周期详解](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference)
- 该页面有着Phase与goal的关系:<img src="./pics/maven-plugin-life-002.png"/>

&nbsp;&nbsp; Maven有三套相互独立的生命周期，分别为:
1. clean: clean生命周期的目的是清理项目
2. default: default生命周期的目的是构建项目
3. site: site生命周期的目的是建立项目站点

&nbsp;&nbsp;每一个生命周期包含一些阶段(**phase,即对应mvn命令中的phase(s)**)，这些阶段都是有顺序的，并且后面的阶段依赖于前面的阶段，用户和Maven最直接的交互方式就是调用这些生命周期阶段。以clean生命周期为例子，clean生命周期包含的阶段: pre-clean 、 clean 、 post-clean。当用户：
  - 调用pre-clean的时候，只有pre-clean阶段得以执行。
  - 调用clean的时候，pre-clean,clean阶段会得以顺序执行
  - 调用post-clean时，pre-clean、clean、post-clean会得以顺序执行。

&nbsp;&nbsp;较之于生命周期阶段的前后依赖关系，三套生命周期本身是相互独立的，用户可以仅仅调用clean生命周期的某一个阶段，或者仅仅调用default生命周期的某一个阶段而不会对其他生命周期产生任何影响。

### 2-1. clean生命周期
&nbsp;&nbsp;clean生命周期的目的是清理项目，包含三个阶段:
1. pre-clean: 执行一些清理前所需要完成的工作
2. clean: 清理上一次构建生成的文件
3. post-clean: 执行一些清理后需要完成的工作。

### 2-2.default生命周期
&nbsp;&nbsp;default生命周期定义了真正构建时所需要执行的所有步骤，他是所有生命周期中最核心的部分，包含的阶段如下:部分，详细请参考:[http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference)
1. validate - validate the project is correct and all necessary information is available
2. compile - compile the source code of the project: 编译项目的主资源文件，一般来说，是src/main/java目录下的Java文件至项目输出的主classpath中。
3. test - test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed
4. package - take the compiled code and package it in its distributable format, such as a JAR.：接受编译好的代码，打包成可以发布的格式，如jar
5. verify - run any checks on results of integration tests to ensure quality criteria are met
6. install - install the package into the local repository, for use as a dependency in other projects locally: 将包安装到Maven本地仓库，供本地其他Maven项目使用。
7. deploy - done in the build environment, copies the final package to the remote repository for sharing with other developers and projects.： 将最终的包复制到远程仓库，供其他开发人员和Maven项目使用。
### 2-3. site生命周期
&nbsp;&nbsp;site生命周期的目的是建立和发布项目站点，Maven能够基于POM所包含的信息，自动生成一个友好的站点，方便团队交流和发布项目信息。该生命周期包含如下阶段: 执行一些在生成项目站点之前需要完成的工作。
1. pre-site：	execute processes needed prior to the actual project site generation:
2. site：	generate the project's site documentation： 生成项目站点文档
3. post-site：	execute processes needed to finalize the site generation, and to prepare for site deployment： 执行一些在生成项目站点之后需要完成的工作。
4. site-deploy：	deploy the generated site documentation to the specified web server：将生成的项目站点发布到服务器上。

## 3. 命令行和生命周期
### 3-1.小结
&nbsp;&nbsp;从如下的笔记来说，了解了Maven不同的生命周期的各个阶段所做的工作，可以将这些阶段(不限于一个生命周期)进行组合，来实现我们所需要的构建动作。
### 3-2. 生命周期和命令行的关系
&nbsp;&nbsp;从命令行执行Maven任务的最主要方式就是调用Maven的生命周期阶段。需要注意的是： **各个生命周期是相互独立的，而一个生命周期的阶段是有先后关系的**。将使用如下的常见的Maven命令为例，解释其执行的生命周期阶段:
1. mvn clean: 该命令调用clean生命周期的clean阶段。实际执行的阶段为clean生命周期的pre-clean 和 clean阶段。
2. mvn test: 该命令调用default生命周期的test阶段，实际执行的阶段是default生命周期的validate,initialize等，直到test的所有阶段。这就是为什么在执行测试的时候，项目的代码能够自动得以编译。
3. mvn clean install: 该命令调用了clean生命周期的clean阶段和default生命周期的install阶段。实际执行的阶段是:
      - clean生命周期的pre-clean,clean阶段，
      - 以及default生命周期的从validate至install的所有阶段。
      - 该命令结合了两个生命周期，在执行真正的项目构建之前清理项目是一个很好的实践。
4. mvn clean deploy site-deploy: 该命令调用clean生命周期的clean阶段，default生命周期的deploy阶段以及site生命周期的site-deploy阶段。实际执行的阶段为:
      - clean 生命周期的pre-clean,clean阶段，
      - default生命周期的所有阶段，
      - 以及site生命周期的所有阶段
      - 该命令结合了Maven所有三个生命周期，且deploy为default生命周期的最后一个阶段，site-deploy为site生命周期的最后一个阶段。

## 4. 插件目标
### 4-1.背景
&nbsp;&nbsp;Maven的核心仅仅定义了抽象的生命周期，具体的任务是交由插件完成的，插件以独立的构建形式存在。也正因如此，Maven核心的分发包只有不到3MB的大小，Maven会在需要的时候下载并使用插件。
### 4-2.什么是"插件目标"(即 插件的一个功能)
&nbsp;&nbsp;对于插件本身，为了能够复用代码，他往往能够完成多个任务。例如: maven-dependency-plugin,他能够基于项目依赖做很多事情，例如:
1. 能够分析项目的依赖，帮助找出潜在的无用依赖
2. 能够列出项目的依赖树，帮助分析依赖来源；
3. 能够列出项目所有已解析的依赖
4. ......

为每个这样的功能编写一个独立的插件显然是不可取的，因为这些任务背后有很多可以复用的代码，因此，这些功能聚集在一个插件里，**每个功能就是一个插件目标**。上述的功能分别对应如下的插件目标:
1. dependency:analyze
2. dependency:tree
3. dependency:list

可以看出，插件目标的通用写法为: 以冒号分隔，冒号左边是插件前缀，右边是该插件的目标。




----------------
## 3. Maven的命令格式
&nbsp;&nbsp;如下图: <img src="./pics/mvn-command-001.png"/>

&nbsp;&nbsp;通过如上截图，可以看出，maven的命令格式:
+ mvn [options] [<goal(s)>] [<phase(s)>]
   1. options: 如mvn --help输出的，这里不做赘述
   2. goal(s): 即插件目标. 在maven插件的主页搜索Goals Overview,可以知道插件的goal.如下图: 
       - <img src="./pics/mvn-command-002.png" />
       - 链接:[http://maven.apache.org/archetype/maven-archetype-plugin/](http://maven.apache.org/archetype/maven-archetype-plugin/)
   3. phase(s): 即Maven的生命周期
